name: Pipeline Deploy Account Level Infrastructure

on:
  push:
    branches:
      - 'main'

jobs:
    metadata:
      name: "Get Metadata"
      uses: NHSDigital/uec-dos-management/.github/workflows/metadata.yaml@task/DR-800_Dependabot_pull_requests
    deploy-account-infrastructure-apply-dev:
      name: "Deploy Account Level Infrastructure to dev account"
      needs:
        [
          metadata,
        ]
      uses: NHSDigital/uec-dos-management/.github/workflows/deploy-infrastructure.yaml@task/DR-800_Dependabot_pull_requests
      with:
        environment: dev
        domain: "uec-cm"
        project: cm
        workspace: ${{ needs.metadata.outputs.workspace }}
        stacks: '["terraform_management", "github-runner"]'
        action: apply
      secrets: inherit
    deploy-account-infrastructure-apply-test:
      name: "Deploy Account Level Infrastructure to test account"
      needs:
        [
          metadata,
        ]
      uses: NHSDigital/uec-dos-management/.github/workflows/deploy-infrastructure.yaml@task/DR-800_Dependabot_pull_requests
      with:
        environment: test
        domain: "uec-cm"
        project: cm
        workspace: ${{ needs.metadata.outputs.workspace }}
        stacks: '["terraform_management", "github-runner"]'
        action: apply
      secrets: inherit
    deploy-account-infrastructure-apply-int:
      name: "Deploy Account Level Infrastructure to integration account"
      needs:
        [
          metadata,
        ]
      uses: NHSDigital/uec-dos-management/.github/workflows/deploy-infrastructure.yaml@task/DR-800_Dependabot_pull_requests
      with:
        environment: int
        domain: "uec-cm"
        project: cm
        workspace: ${{ needs.metadata.outputs.workspace }}
        stacks: '["terraform_management","github-runner"]'
        action: apply
      secrets: inherit
    deploy-account-infrastructure-apply-preprod:
      name: "Deploy Account Level Infrastructure to preprod account"
      needs:
        [
          metadata,
        ]
      uses: NHSDigital/uec-dos-management/.github/workflows/deploy-infrastructure.yaml@task/DR-800_Dependabot_pull_requests
      with:
        environment: preprod
        domain: "uec-cm"
        project: cm
        workspace: ${{ needs.metadata.outputs.workspace }}
        stacks: '["terraform_management", "github-runner"]'
        action: apply
      secrets: inherit
    deploy-account-infrastructure-apply-prod:
      name: "Deploy Account Level Infrastructure to prod account"
      needs:
        [
          metadata,
        ]
      uses: NHSDigital/uec-dos-management/.github/workflows/deploy-infrastructure.yaml@task/DR-800_Dependabot_pull_requests
      with:
        environment: prod
        domain: "uec-cm"
        project: cm
        workspace: ${{ needs.metadata.outputs.workspace }}
        stacks: '["terraform_management", "github-runner"]'
        action: apply
      secrets: inherit
    slack-notifications:
      name: Send notification to slack
      needs: [
        metadata,
        deploy-account-infrastructure-apply-dev,
        deploy-account-infrastructure-apply-test,
      ]
      if: always()
      uses: NHSDigital/uec-dos-management/.github/workflows/slack-notifications.yaml@task/DR-800_Dependabot_pull_requests
      with:
        env: dev
      secrets: inherit


